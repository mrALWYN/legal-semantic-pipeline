version: "3.8"
services:
  # =======================
  # üß† QDRANT VECTOR DB
  # =======================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/readyz"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 30s

  # =======================
  # üìä MLFLOW TRACKING SERVER
  # =======================
  mlflow:
    image: openeuler/mlflow:latest
    container_name: mlflow
    ports:
      - "5000:5000"
    environment:
      MLFLOW_ARTIFACT_ROOT: /mlflow/artifacts
      BACKEND_STORE_URI: sqlite:////mlflow/db/mlflow.db
    volumes:
      - ./mlflow_artifacts:/mlflow/artifacts
      - ./mlflow_db:/mlflow/db
    command: >
      mlflow server
      --backend-store-uri sqlite:////mlflow/db/mlflow.db
      --default-artifact-root /mlflow/artifacts
      --host 0.0.0.0
      --port 5000
      --serve-artifacts
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000"]
      interval: 15s
      timeout: 10s
      retries: 15
      start_period: 30s

  # =======================
  # ‚öñÔ∏è FASTAPI LEGAL API
  # =======================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: legal_api
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - COLLECTION_NAME=legal_precedents
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - REGISTERED_MODEL_NAME=legal-embed-model
      - PYTHONPATH=/
      - HF_HOME=/app/models
      - PYTHONUNBUFFERED=1
    ports:
      - "8000:8000"
    volumes:
      - ./app:/app:cached
      - huggingface_models:/app/models
    restart: always
    command: >
      sh -c "
      echo '‚è≥ Waiting for dependencies...' &&
      until curl -fsS http://qdrant:6333/readyz; do
        echo '‚è≥ Waiting for Qdrant...';
        sleep 2;
      done;
      until curl -fsS http://mlflow:5000; do
        echo '‚è≥ Waiting for MLflow...';
        sleep 2;
      done;
      echo '‚úÖ Dependencies ready. Starting FastAPI...' &&
      uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 1"

# =======================
# üóÑÔ∏è NAMED VOLUMES
# =======================
volumes:
  qdrant_data:
  mlflow_artifacts:
  mlflow_db:
  huggingface_models:
